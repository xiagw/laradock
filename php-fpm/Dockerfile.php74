FROM ubuntu:20.04
ENV TIME_ZOME Asia/Shanghai
RUN set -xe \
    && sed -i 's/archive.ubuntu.com/mirrors.ustc.edu.cn/g' /etc/apt/sources.list \
    && apt-get update \
    && apt-get install -y --no-install-recommends apt-utils \
    && apt-get upgrade -y \
    && { echo 6; echo 70; } | apt-get install -y --no-install-recommends tzdata \
    && apt-get -y install --no-install-recommends nginx \
    && apt-get -y install --no-install-recommends \
        php7.4 \
        php7.4-fpm \
        php7.4-gd \
        php7.4-mysql \
        php7.4-xml \
        php7.4-xmlrpc \
        php-redis \
        php-mongodb \
        php-imagick \
        # php7.4-pecl-mcrypt  replace by  php7.4-libsodium
        php7.4-bcmath \
        php7.4-gmp \
        php7.4-zip \
        php7.4-soap \
        # php7.4-process \
    && apt clean all && rm -rf /tmp/*
RUN set -xe \
    && sed -i \
        -e '/fpm.sock/s/^/;/' \
        -e '/fpm.sock/a listen = 9000' \
        -e '/listen.allowed/ a listen.allowed_clients = 0.0.0.0' \
        -e '/rlimit_files/ a rlimit_files = 51200' \
        -e '/pm = dynamic/s/dynamic/ondemand/' \
        -e '/pm.max_children/s/5/2000/'  \
        -e '/pm.start_servers/s/2/10/'  \
        -e '/pm.min_spare_servers/s/1/10/'  \
        -e '/pm.max_spare_servers/s/3/20/' \
        /etc/php/7.4/fpm/pool.d/www.conf \
    && sed -i \
        -e "/memory_limit/s/128M/256M/" \
        -e "/post_max_size/s/8M/256M/" \
        -e "/upload_max_filesize/s/2M/256M/" \
        -e "/max_file_uploads/s/20/256/" \
        /etc/php/7.4/fpm/php.ini \
    # && chmod -R 777 /var/lib/php/sessions \
    && mkdir -p /run/php \
    && printf '#!/bin/bash\ntrap "exit 0" HUP INT PIPE QUIT TERM\n/usr/sbin/php-fpm7.4\nexec nginx -g "daemon off;"\n' >/run.sh \
    && chmod +x /run.sh


## copy nginx conf
# COPY ./etc/ /etc/

EXPOSE 80
EXPOSE 443
EXPOSE 9000

# WORKDIR /var/www/html
WORKDIR /app

CMD ["/run.sh"]
